<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>편지 작성</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            background: #fff;
            width: 100%;
            max-width: 420px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            box-sizing: border-box;
        }

        h2 {
            margin-bottom: 20px;
            color: #343a40;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-size: 14px;
        }

        input[type="text"], textarea, select, input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .hidden {
            display: none;
        }

        button {
            background: #007bff;
            border: none;
            padding: 12px 20px;
            color: white;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
        }

        button:hover {
            background: #0056b3;
        }

        /* 아주 작은 화면에서도 보기 좋게 */
        @media (max-width: 360px) {
            h2 {
                font-size: 18px;
            }
            input[type="text"], textarea, select, input[type="file"] {
                font-size: 13px;
                padding: 8px;
            }
            button {
                font-size: 14px;
                padding: 10px;
            }
        }

    </style>
    <script>
        function toggleInputType() {
            const inputType = document.getElementById("inputType").value;
            const textInput = document.getElementById("textInput");
            const voiceInput = document.getElementById("voiceInput");

            if (inputType === "TEXT") {
                textInput.classList.remove("hidden");
                voiceInput.classList.add("hidden");
            } else {
                textInput.classList.add("hidden");
                voiceInput.classList.remove("hidden");
            }
        }
    </script>
</head>
<body>
<div class="container">
    <h2>편지 작성</h2>
    <form th:action="@{/letters/send}" method="post" enctype="multipart/form-data">
        <!-- 받는 사람 (가족 드롭다운) -->
        <div class="form-group">
            <label for="receiverId">받는 사람</label>
            <select id="receiverId" name="receiverId" required>
                <option value="" disabled selected>가족을 선택하세요</option>
                <option th:each="family : ${familyList}"
                        th:value="${family.id}"
                        th:text="${family.displayName}">
                </option>
            </select>
        </div>

        <!-- 제목 -->
        <div class="form-group">
            <label for="title">제목</label>
            <input type="text" id="title" name="title" required>
        </div>

        <!-- 입력 방식 -->
        <div class="form-group">
            <label for="inputType">입력 방식</label>
            <select id="inputType" name="inputType" onchange="toggleInputType()" required>
                <option value="TEXT">텍스트 입력</option>
                <option value="STT">음성 업로드(STT 변환)</option>
            </select>
        </div>

        <!-- 텍스트 입력 -->
        <div id="textInput" class="form-group">
            <label for="content">내용</label>
            <textarea id="content" name="content"></textarea>
        </div>

        <!-- 음성 파일 업로드 + 녹음 -->
        <!-- 음성 파일 업로드 + 녹음 -->
        <div id="voiceInput" class="form-group hidden">
            <p style="font-size: 13px; color: #6c757d;">
                ※ 녹음하거나 업로드한 음성을 텍스트로 변환합니다.
            </p>
            <label for="voiceFile">음성 입력</label>
            <input type="file" id="voiceFile" name="voiceFile" accept="audio/*">

            <div style="margin-top: 10px;">
                <button type="button" id="startRecording">녹음 시작</button>
                <button type="button" id="stopRecording" disabled>녹음 종료</button>
                <button type="button" id="sttButton" disabled>텍스트 변환</button>
            </div>

            <p id="recordStatus" style="font-size: 13px; color: #28a745;"></p>

            <!-- 녹음 재생 -->
            <audio id="audioPreview" controls class="hidden" style="margin-top:10px;"></audio>

            <!-- STT 변환 결과 표시 -->
            <textarea id="text" name="text" placeholder="변환된 텍스트가 여기에 표시됩니다." style="margin-top:10px; display:block;"></textarea>
        </div>


        <script>
            document.addEventListener('DOMContentLoaded', () => {
                let mediaRecorder;
                let audioChunks = [];

                const startBtn = document.getElementById('startRecording');
                const stopBtn = document.getElementById('stopRecording');
                const sttBtn = document.getElementById('sttButton');
                const status = document.getElementById('recordStatus');
                const audioPreview = document.getElementById('audioPreview');
                const voiceFileInput = document.getElementById('voiceFile');
                const contentTextArea = document.getElementById('content');

                startBtn.addEventListener('click', async () => {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];

                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(new File([audioBlob], "recording.wav"));
                        voiceFileInput.files = dataTransfer.files;

                        audioPreview.src = URL.createObjectURL(audioBlob);
                        audioPreview.classList.remove('hidden');

                        sttBtn.disabled = false;
                        status.textContent = "녹음 완료, STT 변환 가능";
                        console.log("녹음 완료, Blob 생성:", audioBlob);
                    });

                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    status.textContent = "녹음 중...";
                });

                stopBtn.addEventListener('click', () => {
                    mediaRecorder.stop();
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    console.log("녹음 중지 버튼 클릭");
                });

                sttBtn.addEventListener('click', async () => {
                    console.log("STT 버튼 클릭");
                    const file = voiceFileInput.files[0];
                    if (!file) {
                        alert("녹음 또는 파일을 먼저 선택해주세요.");
                        console.log("파일 없음");
                        return;
                    }

                    const formData = new FormData();
                    formData.append('voiceFile', file);

                    status.textContent = "STT 변환 중...";
                    console.log("STT 요청 전, 파일:", file);

                    try {
                        const response = await fetch('/api/stt', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            status.textContent = "STT 변환 실패: " + response.statusText;
                            console.error("STT 변환 실패", response.status);
                            return;
                        }

                        const data = await response.json();
                        console.log("STT 응답:", data);

                        const sttTextArea = document.getElementById('text');
                        sttTextArea.value = data.text;

                        status.textContent = "STT 변환 완료";
                    } catch (error) {
                        console.error("STT 변환 에러:", error);
                        status.textContent = "STT 변환 중 오류 발생";
                    }
                });
            });
        </script>


        <!-- 이미지 첨부 -->
        <div class="form-group">
            <label for="letterImg">이미지 첨부 (최대 1장)</label>
            <input type="file" id="letterImg" name="letterImg" accept="image/*">
        </div>

        <!-- 제출 -->
        <button type="submit">편지 보내기</button>

        <!-- 로딩 인디케이터 (처음엔 숨김) -->
        <div id="loading" class="hidden" style="text-align:center; margin-top:20px;">
            <div class="spinner" style="
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    "></div>
            <p>편지를 보내는 중입니다...</p>
        </div>

        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const form = document.querySelector("form");
                const loading = document.getElementById("loading");

                form.addEventListener("submit", () => {
                    loading.classList.remove("hidden");  // 로딩 보이기
                });
            });
        </script>
    </form>
</div>
</body>
</html>

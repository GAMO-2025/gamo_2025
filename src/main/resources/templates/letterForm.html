<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>편지 작성</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* PC: 중앙 정렬 + 고정 너비 + 여백 */
        @media (min-width: 640px) {
            body {
                padding: 2rem;
            }
            .app-container {
                max-width: 420px;
                margin: 0 auto;
                border-radius: 1rem;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
        }

        /* 모바일: 전체 화면 */
        @media (max-width: 639px) {
            body {
                padding: 0;
            }
            .app-container {
                width: 100%;
                min-height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- 웹앱 컨테이너 -->
<div class="app-container bg-white overflow-auto flex flex-col p-5">

    <h2 class="text-center text-gray-800 text-xl font-semibold mb-5">편지 작성</h2>

    <form th:action="@{/letters/send}" method="post" enctype="multipart/form-data" class="flex flex-col gap-4">

        <!-- 받는 사람 -->
        <div class="flex flex-col">
            <label for="receiverId" class="font-medium text-gray-700 text-sm mb-1">받는 사람</label>
            <select id="receiverId" name="receiverId" required
                    class="border border-gray-300 rounded-md p-2 text-sm">
                <option value="" disabled selected>가족을 선택하세요</option>
                <option th:each="family : ${familyList}"
                        th:value="${family.id}"
                        th:text="${family.displayName}">
                </option>
            </select>
        </div>

        <!-- 제목 -->
        <div class="flex flex-col">
            <label for="title" class="font-medium text-gray-700 text-sm mb-1">제목</label>
            <input type="text" id="title" name="title" required
                   class="border border-gray-300 rounded-md p-2 text-sm">
        </div>

        <!-- 입력 방식 -->
        <div class="flex flex-col">
            <label for="inputType" class="font-medium text-gray-700 text-sm mb-1">입력 방식</label>
            <select id="inputType" name="inputType" onchange="toggleInputType()" required
                    class="border border-gray-300 rounded-md p-2 text-sm">
                <option value="TEXT">텍스트 입력</option>
                <option value="STT">음성 입력(STT 변환)</option>
            </select>
        </div>

        <!-- 텍스트 입력 -->
        <div id="textInput" class="flex flex-col">
            <label for="content" class="font-medium text-gray-700 text-sm mb-1">내용</label>
            <textarea id="content" name="content"
                      class="border border-gray-300 rounded-md p-2 text-sm min-h-[120px] resize-y"></textarea>
        </div>

        <!-- 음성 입력 -->
        <div id="voiceInput" class="flex flex-col hidden">
            <p class="text-gray-500 text-xs mb-1">※ 녹음하거나 업로드한 음성을 텍스트로 변환합니다.</p>
            <label for="voiceFile" class="font-medium text-gray-700 text-sm mb-1">음성 입력</label>
            <input type="file" id="voiceFile" name="voiceFile" accept="audio/*"
                   class="border border-gray-300 rounded-md p-2 text-sm">

            <div class="flex gap-2 mt-2 flex-wrap">
                <button type="button" id="startRecording"
                        class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">녹음 시작</button>
                <button type="button" id="stopRecording" disabled
                        class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 disabled:bg-gray-400">녹음 종료</button>
                <button type="button" id="sttButton" disabled
                        class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 disabled:bg-gray-400">텍스트 변환</button>
            </div>

            <p id="recordStatus" class="text-green-600 text-xs mt-1"></p>
            <audio id="audioPreview" controls class="hidden mt-2 w-full"></audio>
            <textarea id="text" name="text"
                      placeholder="변환된 텍스트가 여기에 표시됩니다."
                      class="border border-gray-300 rounded-md p-2 text-sm mt-2 min-h-[80px]"></textarea>
        </div>

        <!-- 이미지 첨부 -->
        <div class="flex flex-col">
            <label for="letterImg" class="font-medium text-gray-700 text-sm mb-1">이미지 첨부 (최대 1장)</label>
            <input type="file" id="letterImg" name="letterImg" accept="image/*"
                   class="border border-gray-300 rounded-md p-2 text-sm">
        </div>

        <!-- 제출 버튼 -->
        <button type="submit" class="bg-blue-500 text-white rounded-md py-2 text-sm mt-3 hover:bg-blue-600 transition">
            편지 보내기
        </button>

        <!-- 로딩 -->
        <div id="loading" class="hidden flex flex-col items-center mt-4">
            <div class="border-4 border-gray-200 border-t-4 border-t-blue-500 rounded-full w-10 h-10 animate-spin mb-2"></div>
            <p class="text-gray-600 text-xs">편지를 보내는 중입니다...</p>
        </div>

    </form>
</div>

<!-- JS -->
<script>
    function toggleInputType() {
        const inputType = document.getElementById("inputType").value;
        const textInput = document.getElementById("textInput");
        const voiceInput = document.getElementById("voiceInput");

        if (inputType === "TEXT") {
            textInput.classList.remove("hidden");
            voiceInput.classList.add("hidden");
        } else {
            textInput.classList.add("hidden");
            voiceInput.classList.remove("hidden");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("form");
        const loading = document.getElementById("loading");

        form.addEventListener("submit", () => {
            loading.classList.remove("hidden");
        });

        // 녹음 관련 JS
        let mediaRecorder;
        let audioChunks = [];

        const startBtn = document.getElementById('startRecording');
        const stopBtn = document.getElementById('stopRecording');
        const sttBtn = document.getElementById('sttButton');
        const status = document.getElementById('recordStatus');
        const audioPreview = document.getElementById('audioPreview');
        const voiceFileInput = document.getElementById('voiceFile');

        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];

                mediaRecorder.addEventListener('dataavailable', event => audioChunks.push(event.data));

                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(new File([audioBlob], "recording.wav"));
                    voiceFileInput.files = dataTransfer.files;
                    audioPreview.src = URL.createObjectURL(audioBlob);
                    audioPreview.classList.remove('hidden');
                    sttBtn.disabled = false;
                    status.textContent = "녹음 완료, STT 변환 가능";
                });

                startBtn.disabled = true;
                stopBtn.disabled = false;
                status.textContent = "녹음 중...";
            } catch (error) {
                console.error(error);
                status.textContent = "마이크 접근 권한이 필요합니다.";
            }
        });

        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            startBtn.disabled = false;
            stopBtn.disabled = true;
        });

        sttBtn.addEventListener('click', async () => {
            const file = voiceFileInput.files[0];
            if (!file) return alert("녹음 또는 파일을 먼저 선택해주세요.");

            const formData = new FormData();
            formData.append('voiceFile', file);

            status.textContent = "STT 변환 중...";
            try {
                const response = await fetch('/api/stt', { method: 'POST', body: formData });
                if (!response.ok) throw new Error(response.statusText);

                const data = await response.json();
                document.getElementById('text').value = data.text;
                status.textContent = "STT 변환 완료";
            } catch (error) {
                console.error(error);
                status.textContent = "STT 변환 중 오류 발생";
            }
        });
    });
</script>
</body>
</html>
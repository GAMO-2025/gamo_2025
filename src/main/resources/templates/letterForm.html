<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>편지 작성</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background: #fff;
            width: 600px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
        }

        h2 {
            margin-bottom: 20px;
            color: #343a40;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #495057;
        }

        input[type="text"], textarea, select, input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .hidden {
            display: none;
        }

        button {
            background: #007bff;
            border: none;
            padding: 12px 20px;
            color: white;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
        }

        button:hover {
            background: #0056b3;
        }
    </style>
    <script>
        function toggleInputType() {
            const inputType = document.getElementById("inputType").value;
            const textInput = document.getElementById("textInput");
            const voiceInput = document.getElementById("voiceInput");

            if (inputType === "TEXT") {
                textInput.classList.remove("hidden");
                voiceInput.classList.add("hidden");
            } else {
                textInput.classList.add("hidden");
                voiceInput.classList.remove("hidden");
            }
        }
    </script>
</head>
<body>
<div class="container">
    <h2>편지 작성</h2>
    <form th:action="@{/letters}" method="post" enctype="multipart/form-data">
        <!-- 받는 사람 (가족 드롭다운) -->
        <div class="form-group">
            <label for="receiverId">받는 사람</label>
            <select id="receiverId" name="receiverId" required>
                <option value="" disabled selected>가족을 선택하세요</option>
                <option th:each="family : ${familyList}"
                        th:value="${family.id}"
                        th:text="${family.name}">
                </option>
            </select>
        </div>

        <!-- 제목 -->
        <div class="form-group">
            <label for="title">제목</label>
            <input type="text" id="title" name="title" required>
        </div>

        <!-- 입력 방식 -->
        <div class="form-group">
            <label for="inputType">입력 방식</label>
            <select id="inputType" name="inputType" onchange="toggleInputType()" required>
                <option value="TEXT">텍스트 입력</option>
                <option value="STT">음성 업로드(STT 변환)</option>
            </select>
        </div>

        <!-- 텍스트 입력 -->
        <div id="textInput" class="form-group">
            <label for="content">내용</label>
            <textarea id="content" name="content"></textarea>
        </div>

        <!-- 음성 파일 업로드 + 녹음 -->
        <div id="voiceInput" class="form-group hidden">
            <p style="font-size: 13px; color: #6c757d;">
                ※ 업로드하거나 바로 녹음하여 STT 변환 후 텍스트로 저장됩니다.
            </p>
            <label for="voiceFile">음성 입력</label>
            <input type="file" id="voiceFile" name="voiceFile" accept="audio/*">
            <button type="button" id="startRecording">녹음 시작</button>
            <button type="button" id="stopRecording" disabled>녹음 종료</button>
            <p id="recordStatus" style="font-size: 13px; color: #28a745;"></p>
        </div>

        <script>
            function toggleInputType() {
                const inputType = document.getElementById("inputType").value;
                const textInput = document.getElementById("textInput");
                const voiceInput = document.getElementById("voiceInput");

                if (inputType === "TEXT") {
                    textInput.classList.remove("hidden");
                    voiceInput.classList.add("hidden");
                } else {
                    textInput.classList.add("hidden");
                    voiceInput.classList.remove("hidden");
                }
            }

            // 녹음 기능
            let mediaRecorder;
            let audioChunks = [];

            const startBtn = document.getElementById('startRecording');
            const stopBtn = document.getElementById('stopRecording');
            const status = document.getElementById('recordStatus');

            startBtn.addEventListener('click', async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];

                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener('stop', () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const fileInput = document.getElementById('voiceFile');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(new File([audioBlob], "recording.wav"));
                    fileInput.files = dataTransfer.files;

                    status.textContent = "녹음 완료, 업로드 준비 완료";
                });

                startBtn.disabled = true;
                stopBtn.disabled = false;
                status.textContent = "녹음 중...";
            });

            stopBtn.addEventListener('click', () => {
                mediaRecorder.stop();
                startBtn.disabled = false;
                stopBtn.disabled = true;
            });
        </script>


        <!-- 이미지 첨부 -->
        <div class="form-group">
            <label for="letterImg">이미지 첨부 (최대 1장)</label>
            <input type="file" id="letterImg" name="letterImg" accept="image/*">
        </div>

        <!-- 제출 -->
        <button type="submit">편지 보내기</button>
    </form>
</div>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: AppLayout('letter', ~{::content}, null)}">
<th:block th:fragment="content">

    <div class="min-h-screen px-4 pt-8 pb-8">
        <!-- Title Section -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-[#AB8D66]">편지 작성</h2>
            <p class="text-gray-500 text-sm mt-1">소중한 마음을 전해보세요.</p>
        </div>

        <form th:action="@{/letter/send}" method="post" enctype="multipart/form-data" class="flex flex-col gap-5">

            <!-- 편지 작성 카드 -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 space-y-5">
                <!-- 받는 사람 -->
                <div>
                    <label for="receiverId" class="block font-semibold text-gray-900 text-base mb-3">받는 사람</label>
                    <select id="receiverId" name="receiverId" required
                            class="w-full border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5BF76] focus:border-transparent">
                        <option value="" disabled selected>가족을 선택하세요</option>
                        <option th:each="family : ${familyList}"
                                th:value="${family.id}"
                                th:text="${family.displayName}">
                        </option>
                    </select>
                </div>

                <!-- 제목 -->
                <div>
                    <label for="title" class="block font-semibold text-gray-900 text-base mb-3">제목</label>
                    <input type="text" id="title" name="title" required placeholder="편지 제목을 입력하세요"
                           class="w-full border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5BF76] focus:border-transparent">
                </div>

                <!-- 입력 방식 -->
                <div>
                    <label for="inputType" class="block font-semibold text-gray-900 text-base mb-3">입력 방식</label>
                    <select id="inputType" name="inputType" onchange="toggleInputType()" required
                            class="w-full border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5BF76] focus:border-transparent">
                        <option value="TEXT">텍스트 입력</option>
                        <option value="STT">음성 입력(STT 변환)</option>
                    </select>
                </div>

                <!-- 텍스트 입력 -->
                <div id="textInput">
                    <label for="content" class="block font-semibold text-gray-900 text-base mb-3">내용</label>
                    <textarea id="content" name="content" placeholder="편지 내용을 작성해주세요..."
                              class="w-full border border-gray-200 rounded-xl p-3 text-sm min-h-[180px] resize-y focus:outline-none focus:ring-2 focus:ring-[#F5BF76] focus:border-transparent"></textarea>
                </div>

                <!-- 음성 입력 -->
                <div id="voiceInput" class="hidden">
                    <label class="block font-semibold text-gray-900 text-base mb-2">음성 입력</label>
                    <p class="text-gray-500 text-xs mb-4">※ 녹음하거나 업로드한 음성을 텍스트로 변환합니다.</p>

                    <input type="file" id="voiceFile" name="voiceFile" accept="audio/*"
                           class="w-full border border-gray-200 rounded-xl p-3 text-sm mb-3 focus:outline-none focus:ring-2 focus:ring-[#F5BF76] focus:border-transparent">

                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <button type="button" id="startRecording"
                                class="bg-[#F5BF76] text-white font-medium px-2 py-2 rounded-xl text-xs hover:brightness-95 transition whitespace-nowrap">
                            녹음 시작
                        </button>
                        <button type="button" id="stopRecording" disabled
                                class="bg-gray-300 text-gray-600 font-medium px-2 py-2 rounded-xl text-xs transition disabled:opacity-50 whitespace-nowrap">
                            녹음 종료
                        </button>
                        <button type="button" id="sttButton" disabled
                                class="bg-[#AB8D66] text-white font-medium px-2 py-2 rounded-xl text-xs hover:brightness-95 transition disabled:opacity-50 whitespace-nowrap">
                            텍스트 변환
                        </button>
                    </div>

                    <p id="recordStatus" class="text-[#F5BF76] text-sm text-center mb-2"></p>
                    <audio id="audioPreview" controls class="hidden w-full mb-3 rounded-xl"></audio>
                    <textarea id="text" name="text"
                              placeholder="변환된 텍스트가 여기에 표시됩니다."
                              class="w-full border border-gray-200 rounded-xl p-3 text-sm min-h-[120px] focus:outline-none focus:ring-2 focus:ring-[#F5BF76] focus:border-transparent"></textarea>

                    <!-- AI 교정 버튼 -->
                    <button type="button" id="aiCorrectBtn"
                            class="w-full mt-3 bg-[#AB8D66] text-white font-medium rounded-xl py-2 text-sm hover:brightness-95 transition disabled:opacity-50">
                        ✨ AI 교정하기
                    </button>

                </div>

                <!-- 이미지 첨부 -->
                <div>
                    <label for="letterImg" class="block font-semibold text-gray-900 text-base mb-3">이미지 첨부 (최대 1장)</label>
                    <input type="file" id="letterImg" name="letterImg" accept="image/*"
                           class="w-full border border-gray-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5BF76] focus:border-transparent">
                </div>
            </div>

            <!-- 제출 버튼 -->
            <button type="submit"
                    class="w-full bg-[#F5BF76] text-white font-semibold rounded-2xl py-4 text-base shadow-sm hover:brightness-95 transition duration-300 flex justify-center items-center gap-2">
                <span id="submitText">보내기</span>
                <div id="submitSpinner" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>

        </form>
    </div>

    <!-- JS -->
    <script>
        function toggleInputType() {
            const inputType = document.getElementById("inputType").value;
            const textInput = document.getElementById("textInput");
            const voiceInput = document.getElementById("voiceInput");

            if (inputType === "TEXT") {
                textInput.classList.remove("hidden");
                voiceInput.classList.add("hidden");
            } else {
                textInput.classList.add("hidden");
                voiceInput.classList.remove("hidden");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("form");

            form.addEventListener("submit", (e) => {
                const submitBtn = form.querySelector("button[type='submit']");
                const submitText = document.getElementById("submitText");
                const submitSpinner = document.getElementById("submitSpinner");

                submitBtn.disabled = true;
                submitText.textContent = "보내는 중...";
                submitSpinner.classList.remove("hidden");
            });

            // 녹음 관련 JS
            let mediaRecorder;
            let audioChunks = [];

            const startBtn = document.getElementById('startRecording');
            const stopBtn = document.getElementById('stopRecording');
            const sttBtn = document.getElementById('sttButton');
            const status = document.getElementById('recordStatus');
            const audioPreview = document.getElementById('audioPreview');
            const voiceFileInput = document.getElementById('voiceFile');

            startBtn.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];

                    mediaRecorder.addEventListener('dataavailable', event => audioChunks.push(event.data));

                    mediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(new File([audioBlob], "recording.wav"));
                        voiceFileInput.files = dataTransfer.files;
                        audioPreview.src = URL.createObjectURL(audioBlob);
                        audioPreview.classList.remove('hidden');
                        sttBtn.disabled = false;
                        sttBtn.classList.remove('bg-gray-300', 'text-gray-600');
                        sttBtn.classList.add('bg-[#AB8D66]', 'text-white');
                        status.textContent = "✓ 녹음 완료, STT 변환 가능";
                    });

                    startBtn.disabled = true;
                    startBtn.classList.remove('bg-[#F5BF76]', 'text-white');
                    startBtn.classList.add('bg-gray-300', 'text-gray-600');
                    stopBtn.disabled = false;
                    stopBtn.classList.remove('bg-gray-300', 'text-gray-600');
                    stopBtn.classList.add('bg-[#F5BF76]', 'text-white');
                    status.textContent = "● 녹음 중...";
                } catch (error) {
                    console.error(error);
                    status.textContent = "⚠ 마이크 접근 권한이 필요합니다.";
                    status.classList.add('text-red-500');
                }
            });

            stopBtn.addEventListener('click', () => {
                mediaRecorder.stop();
                startBtn.disabled = false;
                startBtn.classList.remove('bg-gray-300', 'text-gray-600');
                startBtn.classList.add('bg-[#F5BF76]', 'text-white');
                stopBtn.disabled = true;
                stopBtn.classList.remove('bg-[#F5BF76]', 'text-white');
                stopBtn.classList.add('bg-gray-300', 'text-gray-600');
            });

            sttBtn.addEventListener('click', async () => {
                const file = voiceFileInput.files[0];
                if (!file) return alert("녹음 또는 파일을 먼저 선택해주세요.");

                const formData = new FormData();
                formData.append('voiceFile', file);

                status.textContent = "⏳ STT 변환 중...";
                status.classList.remove('text-red-500');
                status.classList.add('text-[#F5BF76]');

                try {
                    const response = await fetch('/api/stt', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(response.statusText);

                    const data = await response.json();
                    document.getElementById('text').value = data.text;
                    status.textContent = "✓ STT 변환 완료";
                } catch (error) {
                    console.error(error);
                    status.textContent = "⚠ STT 변환 중 오류 발생";
                    status.classList.remove('text-[#F5BF76]');
                    status.classList.add('text-red-500');
                }
            });
        });
    </script>

</th:block>
</html>